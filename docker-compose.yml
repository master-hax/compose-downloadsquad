version: "3.7"
services:


  vpn-tunnel:
    image: lscr.io/linuxserver/wireguard
    container_name: tunnel-mango
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - /lib/modules:/lib/modules
      - wgclient-data-volume:/config
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0 # for raspberry pi compatibility?

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    restart: unless-stopped
    volumes:
      - sharebear-volume:/media
      - radarr-data-volume:/config
    environment:
      - TZ=America/Los_Angeles
      - PUID=1020
      - PGID=4321

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    restart: unless-stopped
    volumes:
      - sharebear-volume:/media
      - lidarr-data-volume:/config
    environment:
      - TZ=America/Los_Angeles
      - PUID=1021
      - PGID=4321

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    restart: unless-stopped
    volumes:
      - sharebear-volume:/media
      - sonarr-data-volume:/config
    environment:
      - TZ=America/Los_Angeles
      - PUID=1022
      - PGID=4321

  readarr:
    image: lscr.io/linuxserver/readarr:develop
    restart: unless-stopped
    volumes:
      - sharebear-volume:/media
      - readarr-data-volume:/config
    environment:
      - TZ=America/Los_Angeles
      - PUID=1023
      - PGID=4321

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:develop
    restart: unless-stopped
    environment:
      - TZ=America/Los_Angeles
      - PUID=1024
      - PGID=4321
    network_mode: container:tunnel-mango
    volumes:
      - prowlarr-data-volume:/config
    depends_on:
      - container:tunnel-mango
  
  rtorrent:
    image: crazymax/rtorrent-rutorrent:latest
    volumes:
     - sharebear-volume:/media
     - rtorrent-data-volume:/data
    restart: unless-stopped
    environment:
     - TZ=America/Los_Angeles
     - PUID=1025
     - PGID=4321
    ulimits:
      nproc: 65535
      nofile:
        soft: 32000
        hard: 40000
    network_mode: container:tunnel-mango
    depends_on:
      - container:tunnel-mango

  vpn-proxy:
    image: nginx:stable
    restart: unless-stopped
    environment:
      - TZ=America/Los_Angeles
      - PUID=1025
      - PGID=4321
    read_only: true
    tmpfs:
      - /var/run
      - /var/cache/nginx
    volumes:
      - $PWD/internal-proxy.conf:/etc/nginx/conf.d/internal-proxy.conf:ro # can't define a single file below
      - comm-volume:/comm
    network_mode: container:tunnel-mango
    depends_on:
      - container:tunnel-mango

  aggregator-proxy:
    image: nginx:stable
    restart: unless-stopped
    environment:
      TZ: America/Los_Angeles
    read_only: true
    ports:
      - 80:80/tcp
    tmpfs:
      - /var/run
      - /var/cache/nginx
    volumes:
      - $PWD/external-proxy.conf:/etc/nginx/conf.d/external-proxy.conf:ro
      - comm-volume:/comm

volumes:
  comm-volume: # leave this as tmpfs in RAM - it is for container to container communication
    driver_opts:
        type: tmpfs
        device: tmpfs
  sharebear-volume: # this is the downloads & media volume - change this to a persistent volume
    # external: true # setting up this volume manually outside of docker-compose is recommended
    driver_opts:
        type: tmpfs
        device: tmpfs
  rtorrent-data-volume: # this is data for rtorrent - change this to a persistent volume
    driver_opts:
        type: tmpfs
        device: tmpfs
  prowlarr-data-volume: # this is data for prowlarr - change this to a persistent volume
    driver_opts:
        type: tmpfs
        device: tmpfs
  radarr-data-volume: # this is data for radarr - change this to a persistent volume
    driver_opts:
        type: tmpfs
        device: tmpfs
  lidarr-data-volume: # this is data for lidarr - change this to a persistent volume
    driver_opts:
        type: tmpfs
        device: tmpfs
  sonarr-data-volume: # this is data for sonarr - change this to a persistent volume
    driver_opts:
        type: tmpfs
        device: tmpfs
  readarr-data-volume: # this is data for readarr - change this to a persistent volume
    driver_opts:
        type: tmpfs
        device: tmpfs
  wireguard-data-volume: # writeable location of wg0.conf - remove this if you are not using wireguard 
    driver: local
    driver_opts:
        o: bind
        type: none
        device: "$PWD/wireguard/"
networks:
  default:
